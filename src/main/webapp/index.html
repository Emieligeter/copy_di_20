<!DOCTYPE HTML>
<!-- Index page of the Online Book Store. -->

<html lang=”en”>
<head>
<title>Online Book Store</title>
<link rel="stylesheet" href="styles.css">
<meta charset="UTF-8">
</head>

<body>
    <h1>Online Book Store</h1>
	<div id="wrapper">
		<div id="query">
			<p>Which book category are you interested in?</p>
			<div>
				<input id="search" type="text" onkeyup="loadBooks(event)" />
				<input id="autocomplete" type="text" disabled="disabled" /> 
			</div>
		</div>

		<div id="cart">
			<p>Shopping cart</p>
			<p id="costs">Total costs = 0.0 Euros</p>
			<button onclick="location.href='checkout.html'">Checkout</button>
		</div>
	</div>

	<div id="results">
		<h2>Found items</h2>
		<div id="items">
		<p>No items found so far!</p>
		</div>
	</div>


<script>
	let queryReturn;

	function updateCartView() {
		let xmlhttp = new XMLHttpRequest();
		xmlhttp.onreadystatechange = function () {
			if (this.readyState === 4 && this.status === 200) {
				let returnObj = this.responseText;
				let cartViewCosts = document.getElementById("costs");
				cartViewCosts.innerHTML = "Total costs = " + returnObj;
			}
		}
		xmlhttp.open("GET", "http://localhost:8080/onlineStore/rest/cart/costs", true);
		xmlhttp.send();
	}

	function addToCart(product) {
		let shoppingList = [
			{
				item: product,
				numItems: 1
			}
		]

		let xmlhttp = new XMLHttpRequest();
		xmlhttp.onreadystatechange = function() {
			if (this.readyState === 4 && this.status === 204) {
				updateCartView();
			}
		}

		xmlhttp.open("POST", "http://localhost:8080/onlineStore/rest/cart", true);
		xmlhttp.setRequestHeader("Content-type", "application/json");
		xmlhttp.send(JSON.stringify(shoppingList));
	}

	function parseCatalog() {
		let table = "<table>";
		table += "<tr>" +
					"<th>ID</th>" +
					"<th>Short Description</th>" +
					"<th>Long Description</th>" +
					"<th>Cost</th>" +
				"</tr>";

		for (let i = 0; i < queryReturn.length; i++) {
			let entry = queryReturn[i];
			table += "<tr>" +
						"<td>" + entry['itemID'] + "</td>" +
						"<td>" + entry['shortDescription'] + "</td>" +
						"<td>" + entry['longDescription'] + "</td>" +
						"<td>" + entry['cost'] + "</td>" +
						"<td>" +
							"<button id=\"" + entry['itemID'] + "\" onclick =\"addToCart(queryReturn["+ i + "])\">Add to cart</button>" +
						"</td>" +
					"</tr>";
		}

		table += "</table>";

		let resultsBox = document.getElementById("results");
		resultsBox.innerHTML = table;
	}

	function queryCategory(cat) {
		let xmlhttp = new XMLHttpRequest();
		xmlhttp.onreadystatechange = function() {
			if (this.readyState === 4 && this.status === 200) {
				queryReturn = JSON.parse(this.responseText);
				parseCatalog();
			}
		};
		xmlhttp.open("GET", "http://localhost:8080/onlineStore/rest/" + cat, true);
		xmlhttp.send();
	}

	function loadBooks(evt) {
		let searchBox = document.getElementById("search");
		if (evt.key === "Enter") {
			queryCategory(searchBox.value);
		}
	}
</script>


</body>
</html>
